# CI Fixes Applied - December 5, 2025

## Summary
Fixed multiple CI check failures across 7 GitHub Actions workflows by addressing:
1. **Critical**: Alembic migration version exceeding 32-char database limit
2. **Security**: Workflow secrets exposure on fork PRs
3. **Reliability**: Missing Postgres health checks causing race conditions
4. **Build**: Undefined Docker build arg warning

## Changes Made

### 1. Alembic Migration Version Fix 
**Problem**: Migration revision `d9e8_add_trgm_unaccent_display_name` (36 chars) exceeded PostgreSQL's 32-char `VARCHAR(32)` limit in `alembic_version` table, causing:
```
ERROR: value too long for type character varying(32)
```

**Solution**:
- Renamed revision from `d9e8_add_trgm_unaccent_display_name` â†’ `d9e8trgmunaccent` (18 chars)
- Created new migration file: `backend/app/alembic/versions/d9e8_trgm_unaccent.py`
- Old file can be deleted: `backend/app/alembic/versions/d9e8_add_trgm_unaccent_display_name.py`

**Database Fix** (if you have existing data):
```bash
# Connect to your database and run:
psql -h localhost -U postgres -d hear_db -f backend/scripts/fix_alembic_version.sql
```

Or manually:
```sql
UPDATE alembic_version 
SET version_num = 'd9e8trgmunaccent' 
WHERE version_num = 'd9e8_add_trgm_unaccent_display_name';
```

### 2. Workflow Security Guards 
**Problem**: `pull_request_target` workflows failed on fork PRs when trying to use repository secrets.

**Fixed Workflows**:
- `.github/workflows/add-to-project.yml` - Added repo check before using `PROJECTS_TOKEN`
- `.github/workflows/labeler.yml` - Added repo checks for labeler and label-checker jobs

**Changes**:
```yaml
# Only run for same-repo PRs to prevent secret exposure
if: github.event.pull_request.head.repo.full_name == github.repository
```

### 3. Postgres Health Check Improvements 
**Problem**: Backend tests started before PostgreSQL was ready, causing connection failures.

**Fixed Workflows**:
- `.github/workflows/backend-tests.yml`
- `.github/workflows/test-backend.yml`
- `.github/workflows/ci-backend.yml`
- `.github/workflows/ci.yml`

**Added Step**:
```yaml
- name: Wait for Postgres
  run: |
    echo "Waiting for PostgreSQL..."
    for i in {1..30}; do
      if pg_isready -h localhost -p 5432 -U postgres; then
        echo "PostgreSQL ready!"
        exit 0
      fi
      echo "Attempt $i/30"
      sleep 2
    done
    exit 1
```

### 4. Docker Build Fix 
**Problem**: Undefined variable warning `$VITE_API_URL` in frontend Dockerfile.

**Solution**: Changed from default value syntax to explicit ENV declaration:
```dockerfile
# Before
ARG VITE_API_URL=${VITE_API_URL}

# After
ARG VITE_API_URL
ENV VITE_API_URL=${VITE_API_URL}
```

### 5. Debug Logging Enhancement 
Added diagnostic output to `test-backend.yml`:
```yaml
- name: Debug environment
  run: |
    echo "Python version: $(python --version)"
    echo "Pip version: $(pip --version)"
    echo "Installed packages:"
    pip list | head -20
```

## Testing Locally

### Backend Tests
```bash
cd backend
pip install -r requirements.txt
pytest -v --cov=app --cov-report=term-missing
```

### Docker Build
```bash
# Build images
docker build -t hear-backend:local ./backend
docker build -t hear-frontend:local ./frontend

# Start services
docker compose up --build

# Verify backend health
curl http://localhost:8000/api/v1/utils/health-check/
```

### Database Migration
```bash
cd backend
# Run migrations
alembic upgrade head

# Check current version
alembic current
# Should show: d9e8trgmunaccent
```

## Next Steps

1. **Delete old migration file**:
   ```bash
   rm backend/app/alembic/versions/d9e8_add_trgm_unaccent_display_name.py
   ```

2. **Update existing databases** with the SQL fix script (see above)

3. **Push changes** and verify CI passes:
   ```bash
   git add .
   git commit -m "fix: CI failures - migration version, security, health checks"
   git push
   ```

4. **Monitor CI runs** at: https://github.com/AdeliaManafov/hear-ui/actions

## Files Modified

### Workflows (7 files)
- `.github/workflows/add-to-project.yml`
- `.github/workflows/labeler.yml`
- `.github/workflows/backend-tests.yml`
- `.github/workflows/test-backend.yml`
- `.github/workflows/ci-backend.yml`
- `.github/workflows/ci.yml`

### Backend (3 files)
- `backend/app/alembic/versions/d9e8_trgm_unaccent.py` (new)
- `backend/scripts/fix_alembic_version.sql` (new)
- `backend/app/alembic/versions/d9e8_add_trgm_unaccent_display_name.py` (to delete)

### Frontend (1 file)
- `frontend/Dockerfile`

## Expected CI Results

After these fixes:
-  **Add to Project** - Skips on fork PRs (expected)
-  **Labels** - Skips on fork PRs (expected)
-  **Backend CI** - Tests run successfully with Postgres ready
-  **Backend Tests** - All workflows wait for DB before tests
-  **CI / test-backend** - Passes with health checks
-  **Docker Build** - Builds without warnings
-  **E2E Tests (Playwright)** - Backend starts successfully
